<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestión de Clientes - Sistema Hotelero</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body { background-color: #f0f2f5; }
    .navbar { margin-bottom: 20px; }
    .container { margin-top: 20px; }
    .form-section, .client-details-section, .client-list-section {
        background-color: #fff;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
        margin-bottom: 20px;
    }
    .btn-cancelar {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9em;
    }
    .btn-cancelar:hover {
        background-color: #c82333;
    }
    .badge {
        font-size: 0.85em;
        padding: 0.4em 0.8em;
    }
    .table thead th {
        background-color: #007bff;
        color: white;
        vertical-align: middle;
        cursor: pointer;
    }
    .table tbody tr:hover {
        background-color: #f1f1f1;
    }
    .table .btn-sm {
        padding: 5px 10px;
        font-size: 0.85rem;
    }
    .pagination-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 30px;
        gap: 10px;
    }
    .pagination-controls .page-item.active .page-link {
        background-color: #007bff;
        border-color: #007bff;
        color: white;
    }
    .pagination-controls .page-link {
        color: #007bff;
    }
    .pagination-controls .page-link:hover {
        color: #0056b3;
    }
    .no-results {
        text-align: center;
        color: #666;
        margin-top: 30px;
        font-style: italic;
    }
    .btn-back-main-page {
        position: absolute;
        top: 20px;
        left: 20px;
        background-color: #6c757d; /* Gris */
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        text-decoration: none;
        transition: background-color 0.3s ease;
        z-index: 100;
    }
    .btn-back-main-page:hover {
        background-color: #5a6268;
        color: white;
    }
    .search-forms-container {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    @media (min-width: 768px) {
        .search-forms-container {
            flex-direction: row;
            justify-content: space-between;
            align-items: flex-start;
        }
        .search-forms-container form {
            flex: 1;
        }
        .search-forms-container form:first-child {
            margin-right: 1.5rem;
        }
    }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="/dashboard">Oasis Digital</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item">
          <a class="nav-link" href="/dashboard">Dashboard</a>
        </li>
        <li class="nav-item" sec:authorize="hasAnyAuthority('ROLE_RECEPCIONISTA')">
          <a class="nav-link" th:href="@{/clientes/registrar}">Registro Cliente</a>
        </li>
        <li class="nav-item" sec:authorize="hasAnyAuthority('ROLE_RECEPCIONISTA')">
          <a class="nav-link" th:href="@{/reservas/crear}">Reservas</a>
        </li>
        <li class="nav-item" sec:authorize="hasAnyAuthority('ROLE_ADMIN', 'ROLE_RECEPCIONISTA')">
          <a class="nav-link" th:href="@{/habitaciones}">Habitaciones</a>
        </li>
        <li class="nav-item" sec:authorize="hasAnyAuthority('ROLE_ADMIN', 'ROLE_RECEPCIONISTA')">
          <a class="nav-link active" aria-current="page" th:href="@{/clientes/historial}">Historial Cliente</a>
        </li>
        <li class="nav-item dropdown" sec:authorize="hasAnyRole('ROLE_ADMIN')">
          <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownGestion" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            Gestión de Empleados
          </a>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdownGestion">
            <li><a class="dropdown-item" th:href="@{/empleados/registrar}">Registrar Nuevo</a></li>
            <li><a class="dropdown-item" th:href="@{/empleados/lista}">Ver Lista</a></li>
          </ul>
        </li>
        <li class="nav-item" sec:authorize="hasAnyRole('ROLE_ADMIN')">
          <a class="nav-link" th:href="@{/reportes/generar}">Reportes</a>
        </li>
        <li class="nav-item" sec:authorize="hasAnyAuthority('ROLE_ADMIN')">
          <a class="nav-link" th:href="@{/auditoria/logs}">Logs de Auditoría</a>
        </li>
      </ul>
      <ul class="navbar-nav">
        <li class="nav-item">
          <span class="nav-link text-white me-2">Bienvenido, <span sec:authentication="name"></span></span>
        </li>
        <li class="nav-item">
          <form th:action="@{/logout}" method="post">
            <button type="submit" class="btn btn-outline-light">Cerrar Sesión</button>
          </form>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="container">
  <div th:if="${successMessage}" class="alert alert-success" role="alert">
    <span th:text="${successMessage}"></span>
  </div>
  <div th:if="${errorMessage}" class="alert alert-danger" role="alert">
    <span th:text="${errorMessage}"></span>
  </div>

  <div th:if="${cliente}" class="client-details-section">
    <h2 class="mb-4" th:text="'Detalle del Cliente: ' + ${cliente.nombres} + ' ' + ${cliente.apellidos}">Detalle del Cliente</h2>

    <p><strong>Nombres:</strong> <span th:text="${cliente.nombres}"></span></p>
    <p><strong>Apellidos:</strong> <span th:text="${cliente.apellidos}"></span></p>
    <p><strong>DNI:</strong> <span th:text="${cliente.dni}"></span></p>
    <p><strong>Nacionalidad:</strong> <span th:text="${cliente.nacionalidad}"></span></p>
    <p><strong>Email:</strong> <span th:text="${cliente.email}"></span></p>
    <p><strong>Teléfono:</strong> <span th:text="${cliente.telefono}"></span></p>

    <div class="d-flex align-items-center mb-3">
      <a th:href="@{/clientes/editar/{id}(id=${cliente.id})}" class="btn btn-warning me-2">
        <i class="fas fa-edit"></i> Editar Datos del Cliente
      </a>
      <form th:action="@{/clientes/eliminar/{id}(id=${cliente.id})}" method="post" onsubmit="return confirm('¿Estás seguro de que quieres eliminar a este cliente? Esta acción es irreversible y podría afectar reservas.');">
        <button type="submit" class="btn btn-danger">
          <i class="fas fa-trash-alt"></i> Eliminar Cliente
        </button>
      </form>
    </div>

    <hr>
    <h3 class="mt-4">Reservas del Cliente</h3>
    <div th:if="${#lists.isEmpty(reservasCliente)}" class="alert alert-info">
      Este cliente no tiene reservas registradas.
    </div>
    <div th:unless="${#lists.isEmpty(reservasCliente)}">
      <table class="table table-striped table-hover">
        <thead>
        <tr>
          <th>ID Reserva</th>
          <th>Habitación</th>
          <th>Fecha Entrada</th>
          <th>Fecha Salida</th>
          <th>Días Estadía</th>
          <th>Total Pagar</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="reserva : ${reservasCliente}">
          <td th:text="${reserva.id}"></td>
          <td th:text="${reserva.habitacion?.numero + ' (' + reserva.habitacion?.tipo + ')'}"></td>
          <td th:text="${#temporals.format(reserva.fechaInicio, 'dd-MM-yyyy') + ' ' + #temporals.format(reserva.horaEntrada, 'HH:mm')}"></td>
          <td th:text="${#temporals.format(reserva.fechaFin, 'dd-MM-yyyy') + ' ' + #temporals.format(reserva.horaSalida, 'HH:mm')}"></td>
          <td th:text="${reserva.diasEstadia}"></td>
          <td th:text="${'S/.' + #numbers.formatDecimal(reserva.totalPagar, 1, 'POINT', 2, 'COMMA')}"></td>
          <td>
                        <span th:classappend="${reserva.estadoReserva == 'ACTIVA' ? 'bg-primary' :
                                              (reserva.estadoReserva == 'PENDIENTE' ? 'bg-info' :
                                              (reserva.estadoReserva == 'FINALIZADA' ? 'bg-success' :
                                              'bg-danger'))}"
                              class="badge" th:text="${reserva.estadoReserva}"></span>
          </td>
          <td>
            <div th:if="${reserva.estadoReserva == 'ACTIVA' || reserva.estadoReserva == 'PENDIENTE'}">
              <form th:action="@{/reservas/cancelar/{id}(id=${reserva.id})}" method="post" style="display:inline;">
                <button type="submit" class="btn btn-danger btn-sm"
                        onclick="return confirm('¿Estás seguro de que quieres CANCELAR esta reserva? Esta acción liberará la habitación.');">
                  <i class="fas fa-times-circle"></i> Cancelar
                </button>
              </form>

              <form th:if="${reserva.estadoReserva == 'ACTIVA'}" th:action="@{/reservas/finalizar/{id}(id=${reserva.id})}" method="post" style="display:inline; margin-left: 5px;">
                <button type="submit" class="btn btn-success btn-sm"
                        onclick="return confirm('¿Estás seguro de que quieres FINALIZAR esta reserva (realizar Check-out)?');">
                  <i class="fas fa-check-circle"></i> Finalizar
                </button>
              </form>
            </div>
            <div th:unless="${reserva.estadoReserva == 'ACTIVA' || reserva.estadoReserva == 'PENDIENTE'}">
                            <span th:classappend="${reserva.estadoReserva == 'FINALIZADA' ? 'badge bg-success' : 'badge bg-danger'}">
                                <span th:text="${reserva.estadoReserva}"></span>
                            </span>
            </div>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
    <a th:href="@{/clientes/historial}" class="btn btn-primary mt-3">Volver a la Lista de Clientes</a>
  </div>


  <div th:unless="${cliente}" class="client-list-section">
    <h2 class="mb-4">Lista de Clientes Registrados</h2>

    <div class="search-forms-container">
      <form th:action="@{/clientes/historial}" method="get" class="d-flex flex-grow-1">
        <input type="text" name="search" class="form-control me-2" placeholder="Buscar por DNI, Nombres o Apellidos" th:value="${search != null ? search : ''}">
        <button type="submit" class="btn btn-primary">Buscar</button>
      </form>

      <form th:action="@{/clientes/historial}" method="get" class="d-flex w-auto">
        <input type="text" name="dni" class="form-control me-2" placeholder="Buscar detalle por DNI" style="max-width: 220px;">
        <button type="submit" class="btn btn-info">Ver Detalle por DNI</button>
      </form>
    </div>

    <hr class="my-4">

    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead>
        <tr>
          <th scope="col">
            <a th:href="@{/clientes/historial(page=${currentPage}, size=${pageSize}, sortBy='dni', sortDir=${sortBy == 'dni' && sortDir == 'asc' ? 'desc' : 'asc'}, search=${search})}"
               class="text-white text-decoration-none">
              DNI <i th:class="${sortBy == 'dni' ? (sortDir == 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down') : 'fas fa-sort'}"></i>
            </a>
          </th>
          <th scope="col">
            <a th:href="@{/clientes/historial(page=${currentPage}, size=${pageSize}, sortBy='nombres', sortDir=${sortBy == 'nombres' && sortDir == 'asc' ? 'desc' : 'asc'}, search=${search})}"
               class="text-white text-decoration-none">
              Nombres <i th:class="${sortBy == 'nombres' ? (sortDir == 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down') : 'fas fa-sort'}"></i>
            </a>
          </th>
          <th scope="col">
            <a th:href="@{/clientes/historial(page=${currentPage}, size=${pageSize}, sortBy='apellidos', sortDir=${sortBy == 'apellidos' && sortDir == 'asc' ? 'desc' : 'asc'}, search=${search})}"
               class="text-white text-decoration-none">
              Apellidos <i th:class="${sortBy == 'apellidos' ? (sortDir == 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down') : 'fas fa-sort'}"></i>
            </a>
          </th>
          <th scope="col">Email</th>
          <th scope="col">Teléfono</th>
          <th scope="col">Reservas Activas</th>
          <th scope="col">Acciones</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="clienteItem : ${clientesPage.content}">
          <td th:text="${clienteItem.dni}"></td>
          <td th:text="${clienteItem.nombres}"></td>
          <td th:text="${clienteItem.apellidos}"></td>
          <td th:text="${clienteItem.email}"></td>
          <td th:text="${clienteItem.telefono}"></td>
          <td>
            <span th:if="${clienteItem.hasActiveReservations}" class="badge bg-success">Sí <i class="fas fa-check-circle"></i></span>
            <span th:unless="${clienteItem.hasActiveReservations}" class="badge bg-secondary">No <i class="fas fa-times-circle"></i></span>
          </td>
          <td>
            <a th:href="@{/clientes/historial(id=${clienteItem.id})}" class="btn btn-info btn-sm">
              <i class="fas fa-eye"></i> Ver Detalle
            </a>
          </td>
        </tr>
        </tbody>
      </table>
      <div th:if="${clientesPage.totalElements == 0}" class="no-results">
        <p>No se encontraron clientes.</p>
      </div>
    </div>

    <nav aria-label="Page navigation" th:if="${clientesPage != null and clientesPage.totalPages > 0}">
      <ul class="pagination pagination-controls">
        <li class="page-item" th:classappend="${currentPage == 0 ? 'disabled' : ''}">
          <a class="page-link" th:href="@{/clientes/historial(page=${currentPage - 1}, size=${pageSize}, sortBy=${sortBy}, sortDir=${sortDir}, search=${search})}" aria-label="Previous">
            <span aria-hidden="true">&laquo;</span>
          </a>
        </li>
        <li class="page-item" th:each="i : ${#numbers.sequence(0, clientesPage.totalPages - 1)}" th:classappend="${i == currentPage ? 'active' : ''}">
          <a class="page-link" th:href="@{/clientes/historial(page=${i}, size=${pageSize}, sortBy=${sortBy}, sortDir=${sortDir}, search=${search})}" th:text="${i + 1}"></a>
        </li>
        <li class="page-item" th:classappend="${currentPage == clientesPage.totalPages - 1 ? 'disabled' : ''}">
          <a class="page-link" th:href="@{/clientes/historial(page=${currentPage + 1}, size=${pageSize}, sortBy=${sortBy}, sortDir=${sortDir}, search=${search})}" aria-label="Next">
            <span aria-hidden="true">&raquo;</span>
          </a>
        </li>
      </ul>
    </nav>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
      const urlParams = new URLSearchParams(window.location.search);
      const searchParam = urlParams.get('search');
      if (searchParam) {
          const searchInput = document.querySelector('.search-forms-container form:first-child input[name="search"]');
          if (searchInput) {
              searchInput.value = searchParam;
          }
      }
      const dniParam = urlParams.get('dni');
      if (dniParam) {
          const dniInput = document.querySelector('.search-forms-container form:last-child input[name="dni"]');
          if (dniInput) {
              dniInput.value = dniParam;
          }
      }
  });
</script>
</body>
</html>